stages:
  - prepare
  - scrape
  - notify

variables:
  SCRAPE_OUTPUT_FILENAME: status.json

get_booking_times:
  stage: prepare
  image: ruby:3.2-bullseye
  variables:
    DOTENV_FILENAME: dotenv.env
  before_script:
    - cd preparer
    - bundle install
  script:
    - schedule_description=$(ruby schedule_description.rb)
    - booking_times=$(ruby booking_times.rb "$schedule_description")
    - excluded_stations=$(ruby excluded_stations.rb "$schedule_description")
    - echo "Schedule description - $schedule_description, booking times - $booking_times, excluded stations - $excluded_stations"
    - echo "BOOKING_TIMES=$booking_times" >> $CI_PROJECT_DIR/$DOTENV_FILENAME
    - echo "EXCLUDED_STATIONS=$excluded_stations" >> $CI_PROJECT_DIR/$DOTENV_FILENAME
    - cat $CI_PROJECT_DIR/$DOTENV_FILENAME
  artifacts:
    reports:
      dotenv: $DOTENV_FILENAME
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

puppeteer:
  stage: scrape
  image: node:18-bullseye
  needs:
    - get_booking_times
  before_script:
    - apt-get update && apt-get install -y libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2
    - cd scraper
  script:
    - npm ci
    - echo "Running scraper for booking times $BOOKING_TIMES"
    - node index.js "$BOOKING_TIMES" > $SCRAPE_OUTPUT_FILENAME
  artifacts:
    paths:
      - scraper/*.png
      - scraper/$SCRAPE_OUTPUT_FILENAME
    when: always
  retry:
    max: 2
    when: script_failure
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

notify-if-available:
  stage: notify
  image: golang:1.20-bullseye
  before_script:
    - mv scraper/$SCRAPE_OUTPUT_FILENAME notifier/
    - cd notifier
  script:
    - go run . < $SCRAPE_OUTPUT_FILENAME
  needs:
    - puppeteer
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
